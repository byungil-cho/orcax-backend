<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OrcaX 룰렛</title>
  <style>
    body {
      background-color: #001f3f;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 2rem;
    }
    h1 {
      color: #00e0ff;
      font-size: 2.5rem;
    }
    #spin-count {
      font-size: 1.5rem;
      color: gold;
      margin-top: 1rem;
    }
    #result {
      font-size: 1.2rem;
      margin-top: 1rem;
      color: #ffcc00;
    }
    .wheel-container {
      position: relative;
      width: 220px;
      margin: 2rem auto;
    }
    .wheel {
      width: 200px;
      height: 200px;
      border: 10px solid #00e0ff;
      border-radius: 50%;
      margin: 0 auto;
      background: conic-gradient(gold 0deg 72deg, orange 72deg 144deg, red 144deg 216deg, blue 216deg 288deg, green 288deg 360deg);
      transition: transform 3s ease-out;
    }
    .arrow {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 20px solid #ffcc00;
    }
    button {
      padding: 12px 24px;
      margin-top: 1rem;
      font-size: 1.2rem;
      background-color: #00cc99;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #009f7a;
    }
    a.withdraw-link {
      display: inline-block;
      margin-top: 2rem;
      color: #00ccff;
      font-size: 1.1rem;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>🎡 OrcaX 룰렛</h1>
  <div id="spin-count">🎡 남은 스핀: 계산 중...</div>
  <div class="wheel-container">
    <div class="arrow"></div>
    <div class="wheel" id="wheel"></div>
  </div>
  <div id="loading" style="display: none; margin-top: 1rem; color: #00e0ff; font-size: 1.2rem;">⏳ 룰렛 돌리는 중...</div>
  <div id="result"></div>
  <button onclick="spinRoulette()">스핀!</button>
  <audio id="spin-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7a9dbb37a0.mp3?filename=spin-wheel-110411.mp3"></audio>
  <div>
    <a href="https://byungil-cho.github.io/OrcaX/withdraw.html" target="_blank" class="withdraw-link">💸 출금 요청 페이지로 이동</a>
  </div>
  <script>
    const API_BASE = location.hostname === 'localhost'
      ? 'http://localhost:3020'
      : 'https://orcax-roulette-backend.onrender.com';

    const spinCountDisplay = document.getElementById('spin-count');
    const result = document.getElementById('result');
    const wheel = document.getElementById("wheel");
    const spinSound = document.getElementById("spin-sound");
    const loading = document.getElementById("loading");
    const wallet = localStorage.getItem('orcax_user') || 'guest';

    let spinAngle = 0;

    async function updateUserInfo() {
      try {
        const res = await fetch(`${API_BASE}/api/get-score`, {
          credentials: 'include'
        });
        const data = await res.json();
        if (data.success) {
          spinCountDisplay.textContent = `🎡 남은 스핀: ${data.spins} | 점수: ${data.score}`;
        } else {
          throw new Error();
        }
      } catch (e) {
        console.error('유저 정보 불러오기 실패', e);
        spinCountDisplay.textContent = '❌ 사용자 정보 로드 실패';
      }
    }

    async function spinRoulette() {
      try {
        const res = await fetch(`${API_BASE}/api/spin`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet })
        });
        const data = await res.json();

        if (!data.success) {
          alert(data.message || '스핀 실패');
          return;
        }

        spinSound.play();
        loading.style.display = "block";
        result.textContent = "";

        const randomRotation = Math.floor(Math.random() * 360) + 1080;
        spinAngle += randomRotation;
        wheel.style.transform = `rotate(${spinAngle}deg)`;

        setTimeout(async () => {
          loading.style.display = "none";
          const prizeIndex = Math.floor(((spinAngle % 360) + 72 / 2) / 72) % 5;
          const prizes = ['100 ORCAX', '200 ORCAX', '300 ORCAX', '꽝', '10 ORCAX'];
          const prizeValues = [100, 200, 300, 0, 10];
          const reward = prizeValues[prizeIndex];

          result.textContent = reward > 0 ? `🎉 축하합니다! ${prizes[prizeIndex]} 당첨!` : `😢 아쉽지만 ${prizes[prizeIndex]}`;

          if (reward > 0) {
            await fetch(`${API_BASE}/api/save-score`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ wallet, score: reward })
            });
          }

          spinCountDisplay.textContent = `🎡 남은 스핀: ${data.spins} | 점수: ${data.totalScore + reward}`;
        }, 3000);

      } catch (err) {
        console.error('[스핀 요청 실패]', err);
        alert('서버 오류');
      }
    }

    fetch(`${API_BASE}/api/me`, { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (data?.user?.wallet) {
          localStorage.setItem('orcax_user', data.user.wallet);
        }
      })
      .catch(err => console.log('사용자 정보 불러오기 실패', err));

    updateUserInfo();
  </script>
</body>
</html>
